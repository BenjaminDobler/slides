<div class="container">
  <div class="header">
    <div class="header-title">
      <h1>Settings</h1>
      @if (appVersion()) {
        <span class="app-version">v{{ appVersion() }}</span>
      }
    </div>
    <button class="btn-back" (click)="goBack()">&larr; Back</button>
  </div>

  <section>
    <h2>AI Providers</h2>
    <div class="provider-list">
      @for (c of configs(); track c.id) {
        <div class="provider-card">
          @if (editingConfig()?.id === c.id) {
            <!-- Edit mode -->
            <div class="edit-form">
              <div class="edit-header">
                <span class="provider-name">{{ c.providerName }}</span>
              </div>
              <input type="password" [(ngModel)]="editApiKey" placeholder="New API Key (leave empty to keep current)" />
              <input type="text" [(ngModel)]="editBaseUrl" placeholder="Base URL (optional)" [value]="editBaseUrl" />
              @if (editAvailableModels().length > 0) {
                <select [(ngModel)]="editModel">
                  <option value="">Select a model...</option>
                  @for (m of editAvailableModels(); track m.id) {
                    <option [value]="m.id">{{ m.displayName }}</option>
                  }
                </select>
              } @else {
                <input type="text" [(ngModel)]="editModel" placeholder="Model" />
              }
              <div class="edit-actions">
                <button class="btn-save" (click)="saveEdit()">Save</button>
                <button class="btn-cancel" (click)="cancelEdit()">Cancel</button>
              </div>
            </div>
          } @else {
            <!-- View mode -->
            <div class="provider-info">
              <span class="provider-name">{{ c.providerName }}</span>
              @if (c.model) {
                <span class="provider-detail">Model: {{ c.model }}</span>
              }
              @if (c.baseUrl) {
                <span class="provider-detail">Proxy: {{ c.baseUrl }}</span>
              }
            </div>
            <div class="provider-actions">
              <button class="btn-edit" (click)="startEdit(c)">Edit</button>
              <button class="btn-delete" (click)="removeConfig(c.id)">Remove</button>
            </div>
          }
        </div>
      }
    </div>

    <div class="add-provider">
      <h3>Add Provider</h3>
      <select [(ngModel)]="newProvider" (ngModelChange)="onProviderChange()">
        <option value="openai">OpenAI</option>
        <option value="anthropic">Anthropic</option>
        <option value="gemini">Gemini</option>
      </select>
      <input type="text" [(ngModel)]="newBaseUrl" placeholder="Base URL (optional, for proxy)" />
      <input type="password" [(ngModel)]="newApiKey" placeholder="API Key" (blur)="onProviderChange()" />
      @if (availableModels().length > 0) {
        <select [(ngModel)]="newModel">
          <option value="">Select a model...</option>
          @for (m of availableModels(); track m.id) {
            <option [value]="m.id">{{ m.displayName }}</option>
          }
        </select>
      } @else {
        <input type="text" [(ngModel)]="newModel" placeholder="Model (optional)" />
      }
      @if (loadingModels()) {
        <span class="loading-hint">Loading models...</span>
      }
      <button (click)="addConfig()" [disabled]="!newApiKey && !newBaseUrl">Add</button>
    </div>
  </section>
  <section>
    <h2>MCP Server</h2>

    @if (isDesktopApp) {
      <p class="mcp-desc">The MCP server is built into this desktop app and available locally.</p>

      <div class="mcp-help">
        <h3>Setup for Claude Code</h3>
        <p class="mcp-desc">Add the following to your Claude Code MCP settings file (<code>~/.claude/claude_desktop_config.json</code>):</p>
        <pre class="mcp-config"><code>{{'{'}}"mcpServers": {{'{'}}
  "slides": {{'{'}}
    "url": "http://localhost:3332/mcp/sse"
  {{'}'}}
{{'}'}}{{'}'}}</code></pre>
        <p class="mcp-desc">No authentication required — the MCP server runs locally with the desktop app.</p>
      </div>
    } @else {
      <p class="mcp-desc">Use this token to connect the MCP server to external AI tools like Claude Code.</p>
      <div class="token-row">
        <code class="token-display">{{ tokenCopied() ? 'Copied!' : '••••••••••••••••' }}</code>
        <button class="btn-copy" (click)="copyToken()">Copy Token</button>
      </div>

      <div class="mcp-help">
        <h3>Setup for Claude Code</h3>
        <p class="mcp-desc">Add the following to your Claude Code MCP settings file (<code>~/.claude/claude_desktop_config.json</code>):</p>
        <pre class="mcp-config"><code>{{'{'}}"mcpServers": {{'{'}}
  "slides": {{'{'}}
    "command": "npx",
    "args": ["-y", "slides-mcp-server"],
    "env": {{'{'}}
      "SLIDES_AUTH_TOKEN": "&lt;your-token&gt;",
      "SLIDES_BACKEND_URL": "{{ backendUrl }}"
    {{'}'}}
  {{'}'}}
{{'}'}}{{'}'}}</code></pre>
        <p class="mcp-desc">Replace <code>&lt;your-token&gt;</code> with the token copied above.</p>

        <h3>Environment Variables</h3>
        <ul class="env-list">
          <li><code>SLIDES_AUTH_TOKEN</code> — Your authentication token (required)</li>
          <li><code>SLIDES_BACKEND_URL</code> — Backend API URL (default: <code>http://localhost:3332</code>)</li>
        </ul>
      </div>
    }
  </section>
</div>
